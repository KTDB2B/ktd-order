<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KUPEC TRADE</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body{
font-family: Arial;
background:#f5f5f5;
margin:0;
}

header{
background:#111;
color:white;
padding:20px;
text-align:center;
font-size:24px;
}

.container{
max-width:900px;
margin:auto;
padding:20px;
}

.product{
background:white;
padding:15px;
margin-bottom:10px;
border-radius:8px;
display:flex;
justify-content:space-between;
}
</style>
</head>

<body>

<header id="title">KUPEC TRADE DISTRIBUTION</header>
  
<div style="
position:sticky;
top:0;
background:#eee;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
z-index:10;
border-bottom:1px solid #ccc;
">

<div>
Товаров: <b id="cartCount">0</b> |
Сумма: <b id="cartSum">0</b> ₸
</div>

<div>
<button onclick="clearCart()">Очистить</button>
<button onclick="sendOrder()">Отправить заказ</button>
</div>

</div>
  
<div class="container" id="products"></div>

<script>

const supabaseClient = supabase.createClient(
"https://irjdqrdiocmzbiyijzni.supabase.co",
"sb_publishable_8J_23fisR7Oqmset3_A4RA__Cjr5Hhm"
)

let cart = {}
let productsMap = {}

async function loadProducts(){

const { data, error } = await supabaseClient
.from("products")
.select("*")
.eq("is_active", true)

if(error){
console.log(error)
return
}

const container = document.getElementById("products")

container.innerHTML=""

data.forEach(p => {

productsMap[p.id] = p

container.innerHTML += `
<div class="product">

<div style="width:220px">
<b>${p.name}</b><br>
${p.volume} л<br>
${p.price} ₸
</div>

<div>
<button onclick="minus('${p.id}')">−</button>
<span id="q_${p.id}">0</span>
<button onclick="plus('${p.id}')">+</button>
</div>

<div id="sum_${p.id}" style="width:120px;text-align:right">
0 ₸
</div>

</div>
`

})

}

function plus(id){

if(!cart[id]) cart[id] = 0
cart[id]++

updateQty(id)

}

function minus(id){

if(!cart[id]) return
cart[id]--

if(cart[id] < 0) cart[id] = 0

updateQty(id)

}

function updateQty(id){

let qty = cart[id] || 0

document.getElementById("q_"+id).innerText = qty

let p = productsMap[id]

let sum = p.price * qty

document.getElementById("sum_"+id).innerText = sum + " ₸"

updateCart()

}

function clearCart(){

cart = {}

for(let id in productsMap){

document.getElementById("q_"+id).innerText = 0
document.getElementById("sum_"+id).innerText = "0 ₸"

}

updateCart()

}

function updateCart(){

let totalQty = 0
let totalSum = 0

for(let id in cart){

let qty = cart[id]

if(qty > 0){

totalQty += qty
let p = productsMap[id]
totalSum += p.price * qty

}

}

document.getElementById("cartCount").innerText = totalQty
document.getElementById("cartSum").innerText = totalSum

}

function sendOrder(){

let text = ""

if(shop){
text += "Магазин: " + shop.company_name + "\n"
text += "Город: " + shop.city + "\n"
text += "Адрес: " + shop.address + "\n"
text += "Телефон: " + shop.phone + "\n\n"
text += "\nДата: " + new Date().toLocaleString() + "\n\n"
}

text += "Заказ:\n"
let total = 0

for(let id in cart){

let qty = cart[id]

if(qty > 0){

let p = productsMap[id]
let sum = p.price * qty

total += sum

text += p.name + " " + p.volume + "л"
text += " — " + qty + " шт"
text += " = " + sum + " ₸\n"

}

}

text += "%0AИтого: " + total + " ₸"

window.open("https://wa.me/?text=" + encodeURIComponent(text))

}
let shop = null

async function loadShop(){

  const params = new URLSearchParams(window.location.search)
  const token = params.get("t")

  if(!token) return

  const { data } = await supabaseClient
  .from("profiles")
  .select("*")
  .eq("token", token)
  .single()

  shop = data

  if(shop){
  document.getElementById("title").innerText = shop.company_name
}
  }
  

loadShop()
loadProducts()
}

start()
  
</script>

</body>
</html>
